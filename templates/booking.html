{% extends "base.html" %}<!DOCTYPE html><html lang="en">{% block title %}Booking{% endblock %}{% block content %}<head>    <meta charset="UTF-8">    <meta name="viewport" content="width=device-width, initial-scale=1.0">    <title>Booking</title>    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha3/dist/css/bootstrap.min.css" rel="stylesheet">    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>    <style>        .equipment-item {            display: flex;            align-items: center;            margin-bottom: 10px;        }        .equipment-item label {            margin-right: 15px;        }        .equipment-item input {            width: 100px;        }        .form-group {            margin-bottom: 20px;        }        .form-group label {            font-weight: bold;        }        .btn {            width: 100%;        }        .alert {            margin-top: 20px;        }        .loading {            display: none;            color: #007bff;            font-weight: bold;        }        .validation-message {            margin-left: 10px;            font-size: 15px;        }        .card {          box-shadow: 0 4px 8px 0 rgba(0,0,0,0.2);          transition: 0.3s;          border-radius: 5px; /* 5px rounded corners */        }        .feedback-popup {            display: none;            position: fixed;            top: 50%;            left: 50%;            transform: translate(-50%, -50%);            background: white;            padding: 30px 40px;  /* Larger padding for spacious feel */            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.2);            border-radius: 12px; /* Softer corners */            text-align: left;            z-index: 1000;            color: #333;            width: 450px;  /* Adjusted width */            max-width: 90%;            font-size: 16px;  /* Larger font */            line-height: 1.6; /* Increased line spacing for readability */            background-color: #f9f9f9; /* Slight background color */        }        .feedback-popup strong {            font-size: 18px;            color: darkslateblue;        }        #feedback-message {            margin-bottom: 15px;        }        #feedback-popup .button {            display: block;            margin-top: 20px;            padding: 10px 20px;            background-color: #4CAF50;  /* Green button */            color: white;            font-weight: bold;            text-align: center;            border-radius: 5px;            cursor: pointer;        }        #feedback-popup .button:hover {            background-color: #45a049;        }        .overlay {            display: none;            position: fixed;            top: 0;            left: 0;            width: 100%;            height: 100%;            background: rgba(0, 0, 0, 0.5);            z-index: 999;        }        .disabled{            pointer-events: none;            opacity: 0.5;        }    </style></head><body>    <div class="container d-flex justify-content-center align-items-center vh-100">        <div class="card shadow-lg p-4" style="width: 30rem;">        <h1 class="display-6 text-center mb-4"> <strong>Booking Form</strong> </h1>        <form id="booking-form">            <div class="form-group">                <label for="name" class="form-label">Booking Name:</label>                <input type="text" class="form-control" id="name" required placeholder="Enter your booking name">            </div>            <!-- Date Input -->            <div class="form-group">                <label for="date" class="form-label">Booking Date:</label>                <input type="date" class="form-control" id="date" required>            </div>            <!-- Time Slot Input -->            <div class="form-group">                <label for="timeslot" class="form-label">Select Time Slot:</label>                <select class="form-control" id="timeslot" required>                    <option value="">Select Time Slot</option>                    <option value="09:00-09:30">09:00-09:30</option>                    <option value="09:30-10:00">09:30-10:00</option>                    <option value="10:00-10:30">10:00-10:30</option>                    <option value="10:30-11:00">10:30-11:00</option>                    <option value="11:00-11:30">11:00-11:30</option>                    <option value="11:30-12:00">11:30-12:00</option>                    <option value="12:00-12:30">12:00-12:30</option>                    <option value="12:30-13:00">12:30-13:00</option>                    <option value="13:00-13:30">13:00-13:30</option>                    <option value="13:30-14:00">13:30-14:00</option>                    <option value="14:00-14:30">14:00-14:30</option>                    <option value="14:30-15:00">14:30-15:00</option>                    <option value="15:00-15:30">15:00-15:30</option>                    <option value="15:30-16:00">15:30-16:00</option>                    <option value="16:00-16:30">16:00-16:30</option>                    <option value="16:30-17:00">16:30-17:00</option>                    <option value="17:00-17:30">17:00-17:30</option>                    <option value="17:30-18:00">17:30-18:00</option>                </select>            </div>            <!-- Room Selection -->            <div class="form-group">                <label for="room" class="form-label">Select Room:</label>                <select class="form-control" id="room" required disabled>                    <option value="">Select Room</option>                </select>                <div class="loading" id="room-loading">Loading rooms...</div>            </div>            <!-- Equipment List -->            <div class="form-group" id="equipment-list">                <label class="form-label">Equipment:</label>                <div class="loading" id="equipment-loading">Loading equipment...</div>            </div>            <!-- Submit Button -->            <button type="submit" class="btn btn-primary w-100" id="submit-button" disabled>Submit Booking</button>        </form>        <div id="feedback-popup" class="feedback-popup">            <div id="feedback-message"></div>            <button class="button" onclick="window.location.href='/dashboard';">Go to Dashboard</button>        </div>    </div>    <script>        $(document).ready(function () {            const today = new Date();            const todayStr = today.toISOString().split('T')[0]; // YYYY-MM-DD            let canSubmit = false;            $('#date').attr('min', todayStr); // Prevent past dates            function filterTimeSlots() {                const selectedDate = $('#date').val();                const currentTime = new Date();                const currentHour = currentTime.getHours();                const currentMinute = currentTime.getMinutes();                $('#timeslot option').each(function () {                    const timeRange = $(this).val().split('-')[0]; // Get start time (e.g., "09:00" from "09:00-09:30")                    const [hour, minute] = timeRange.split(':').map(Number);                    if (selectedDate === todayStr && (hour < currentHour || (hour === currentHour && minute < currentMinute))) {                        $(this).prop('disabled', true).hide();                    } else {                        $(this).prop('disabled', false).show();                    }                });            }            $('#date').change(function () {                filterTimeSlots();            });            filterTimeSlots();            // Fetch rooms & equipment when date/time changes            $('#date, #timeslot').change(function () {                const date = $('#date').val();                const timeslot = $('#timeslot').val();                if (date && timeslot) {                    fetchAvailableRooms(date, timeslot);                    fetchAvailableEquipment(date, timeslot);                } else {                    $('#room').html('<option value="">Select Room</option>').prop('disabled', true);                    $('#equipment-list').html('');                }            });            function fetchAvailableRooms(date, timeslot) {                $('#room').prop('disabled', true);                $('#room-loading').show();                $.get(`/api/available/rooms?date=${date}&timeslot=${timeslot}`)                    .done(function (data) {                        let roomOptions = '<option value="">Select Room</option>';                        data.rooms.forEach(function (room) {                            roomOptions += `<option value="${room.id}">${room.name}</option>`;                        });                        $('#room').html(roomOptions).prop('disabled', false);                    })                    .always(function () {                        $('#room-loading').hide();                    });            }            function fetchAvailableEquipment(date, timeslot) {                $('#equipment-list').html('');                $('#equipment-loading').show();                $.get(`/api/available/equipments?date=${date}&timeslot=${timeslot}`)                    .done(function (data) {                        let equipmentList = '';                        data.equipments.forEach(function (equipments) {                            equipmentList += `                                <div class="equipment-item">                                    <label for="quantity-${equipments.id}">${equipments.name}</label>                                    <input type="number" class="form-control" id="quantity-${equipments.id}" data-equipment-id="${equipments.id}" min="1" placeholder="Qty">                                </div>                            `;                        });                        $('#equipment-list').html(equipmentList);                    })                    .always(function () {                        $('#equipment-loading').hide();                    });            }             function toggleSubmitButton(canSubmit) {                const submitButton = $('#submit-button');                if (canSubmit) {                    submitButton.prop('disabled', false);                } else {                    submitButton.prop('disabled', true);                }                }            function validateQuantity(equipmentId, quantity, date, timeslot) {                $.get(`/api/validate/quantity?equipment_id=${equipmentId}&quantity=${quantity}&date=${date}&timeslot=${timeslot}`)                    .done(function(data) {                        console.log(data);                        const validationMessage = data.isAvailable ? 'Quantity is available.' : 'Not enough available equipment.';                        canSubmit = data.isAvailable;                        toggleSubmitButton(canSubmit);                        $(`#quantity-${equipmentId}`).next('.validation-message').remove();                        $(`#quantity-${equipmentId}`).after(`<span class="validation-message">${validationMessage}</span>`);                    })                    .fail(function() {                        $(`#quantity-${equipmentId}`).next('.validation-message').remove();                        $(`#quantity-${equipmentId}`).after('<span class="validation-message">Error checking availability.</span>');                    });            }            $('#equipment-list').on('input', 'input[type="number"]', function() {                const equipmentId = $(this).data('equipment-id');                const quantity = $(this).val();                const date = $('#date').val();                const timeslot = $('#timeslot').val();                if (quantity && quantity > 0) {                    validateQuantity(equipmentId, quantity, date, timeslot);                } else {                    $(this).next('.validation-message').remove();                }            });            $('#booking-form').submit(function (event) {                console.log('form submitted');                event.preventDefault();                const name = $('#name').val();                const date = $('#date').val();                const timeslot = $('#timeslot').val();                const room_id = $('#room').val();                const room_name = $('#room option:selected').text();                const equipments = [];            $('#equipment-list input').each(function () {                const equipment_id = $(this).data('equipment-id');                const equipment_name = $(this).prev('label').text();                const quantity = $(this).val();                if (quantity && quantity > 0) {                    equipments.push([equipment_name, equipment_id, quantity]);                }            });            console.log('Form Data:', { name, date, timeslot, room_id, room_name, equipments });            $.ajax({                url: '/api/book',                type: 'POST',                contentType: 'application/json',                data: JSON.stringify({                    name,                    date,                    timeslot,                    room_id,                    room_name,                    equipments                }), // Send room name and ID along with equipment details                success: function (response) {                    // Format and display success message                    const equipmentDetails = response.equipment_booking_details.map(eq => `${eq.name}             Quantity: ${eq.quantity}`).join('<br>');                    $('#feedback-message')                        .html(`                        <strong>Booking successful!</strong> <br>                        <strong>Room:</strong> ${response.room_name} <br>                        <strong>Equipment:</strong> <br>                        ${equipmentDetails}`)                       $('#feedback-popup').show();                        $('#overlay').show();                    $('#booking-form')[0].reset(); // Reset form                    $('#room').prop('disabled', true);                    $('#equipment-list').html('');                },                error: function (xhr) {                    $('#feedback').removeClass().addClass('alert alert-danger')                        .text(xhr.responseJSON?.error || 'Booking failed!')                        $('#feedback-popup').show();                        $('#overlay').show();                }            });        });        });    </script></body>{% endblock %}